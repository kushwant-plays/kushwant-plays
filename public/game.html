<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="dynamicTitle">Game Details - Kushwant Plays</title>

  <!-- ✅ SEO & META -->
  <meta name="title" content="Game Details - Kushwant Plays">
  <meta name="description" content="Discover detailed info and download links for games from Kushwant Plays.">
  <meta name="robots" content="index, follow">
  <meta name="author" content="Kushwant Plays">
  <link rel="canonical" href="https://kushwant-plays.web.app/game.html">
  <link rel="icon" href="assets/playslogo.png" type="image/png" />
  <meta property="og:type" content="article">
  <meta property="og:image" content="https://kushwant-plays.web.app/assets/playslogo.png">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Poppins", sans-serif; }
    body {
      color: #fff;
      background: #000;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Background slideshow */
    .bg-slideshow {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: -1;
      overflow: hidden;
    }
    .bg-slideshow img {
      position: absolute;
      width: 100%; height: 100%;
      object-fit: cover;
      filter: blur(3px) brightness(50%);
      opacity: 0;
      transition: opacity 1.5s ease-in-out;
    }
    .bg-slideshow img.active { opacity: 1; }

    /* Header */
    header {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      background: rgba(15, 15, 15, 0.7);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 30px;
      z-index: 10;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    header .logo { display: flex; align-items: center; gap: 10px; }
    header .logo img { width: 45px; height: 45px; border-radius: 50%; }
    header .logo h1 { font-size: 22px; font-weight: 600; }
    header button {
      background: #ff4747; border: none; color: #fff;
      padding: 8px 16px; border-radius: 6px;
      cursor: pointer; font-weight: 600; transition: 0.3s;
    }
    header button:hover { opacity: 0.85; }

    /* Main container */
    .container {
      max-width: 900px;
      margin: 120px auto 50px;
      background: rgba(20, 20, 20, 0.75);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 30px;
      backdrop-filter: blur(15px);
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.5);
    }
    .game-card img {
      width: 100%;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    a#downloadLink {
      display: inline-block;
      background: #ff4747;
      color: #fff;
      padding: 10px 20px;
      border-radius: 6px;
      text-decoration: none;
      margin-top: 10px;
      transition: 0.3s;
    }
    a#downloadLink:hover { opacity: 0.85; }

    /* Comments */
    .comments { margin-top: 40px; }
    .comment-box textarea {
      width: 100%;
      height: 90px;
      border-radius: 8px;
      border: none;
      padding: 10px;
      margin-bottom: 10px;
      resize: none;
    }
    .comment-box button {
      background: #ff4747;
      border: none;
      padding: 10px 20px;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: 0.3s;
    }
    .comment-box button:hover { opacity: 0.85; }
    .comment {
      background: rgba(255, 255, 255, 0.07);
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
      display: flex;
      gap: 12px;
    }
    .comment img {
      width: 40px; height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    .comment small { color: #aaa; display: block; margin-top: 4px; }
  </style>
</head>

<body>
  <!-- Background slideshow -->
  <div class="bg-slideshow">
    <img src="assets/bg1.jpg" class="active">
    <img src="assets/bg2.jpg">
    <img src="assets/bg3.jpg">
  </div>

  <!-- Header -->
  <header>
    <div class="logo">
      <img src="assets/playslogo.png" alt="Logo" />
      <h1>Kushwant Plays</h1>
    </div>
    <button onclick="window.location.href='games.html'">Back to Games</button>
  </header>

  <!-- Game Details -->
  <div class="container">
    <div class="game-card">
      <h1 id="title"></h1>
      <img id="image" src="" alt="Game image" />
      <p id="desc"></p>
      <a id="downloadLink" href="#" target="_blank">Download</a>

      <div class="comments">
        <h2>Comments</h2>
        <div id="commentList"></div>
        <div class="comment-box">
          <textarea id="commentInput" placeholder="Write a comment..."></textarea>
          <button id="submitComment">Post Comment</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + Tracking -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import {
    getFirestore, doc, getDoc, updateDoc, increment,
    collection, addDoc, getDocs, orderBy, query, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "AIzaSyD_63X6oKFv0TrJpKFLVBta9azbKcZs4Q0",
    authDomain: "kushwant-plays.firebaseapp.com",
    projectId: "kushwant-plays",
    storageBucket: "kushwant-plays.firebasestorage.app",
    messagingSenderId: "257275265481",
    appId: "1:257275265481:web:eebe942139dedde428a818"
  });

  const db = getFirestore(app);

  // Background slideshow
  const slides = document.querySelectorAll(".bg-slideshow img");
  let index = 0;
  setInterval(() => {
    slides[index].classList.remove("active");
    index = (index + 1) % slides.length;
    slides[index].classList.add("active");
  }, 3000);

  function timeAgo(date) {
    if (!date) return "Just now";
    const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
    if (seconds < 60) return "Just now";
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    const days = Math.floor(hours / 24);
    return `${days}d ago`;
  }

  const params = new URLSearchParams(window.location.search);
  const gameId = params.get("id");
  const gameRef = doc(db, "games", gameId);

  // ========== LOAD GAME WITH CACHE (0 reads most times) ==========
  async function loadGame() {
    // Use localStorage cache first
    const cacheKey = `game_${gameId}`;
    const cached = localStorage.getItem(cacheKey);

    if (cached) {
      displayGame(JSON.parse(cached));
    }

    // Fetch from Firestore only once per 24 hours
    const lastFetch = localStorage.getItem(cacheKey + "_time");
    if (lastFetch && Date.now() - lastFetch < 24*60*60*1000) {
      return; // skip firestore read
    }

    const snap = await getDoc(gameRef);  // 1 READ ONLY FIRST TIME
    if (snap.exists()) {
      const data = snap.data();

      // Save to cache
      localStorage.setItem(cacheKey, JSON.stringify(data));
      localStorage.setItem(cacheKey + "_time", Date.now());

      displayGame(data);
      trackView(gameId);
      setupDownload(data.download);
    }
  }

  function displayGame(data) {
    document.getElementById("title").textContent = data.title;
    document.getElementById("desc").textContent = data.desc;
    document.getElementById("image").src = data.img;
    document.getElementById("downloadLink").href = data.download;
    document.title = `${data.title} - Kushwant Plays`;
    document.querySelector('meta[name="description"]').setAttribute("content", data.desc);
  }

  function setupDownload(url) {
    const btn = document.getElementById("downloadLink");
    btn.addEventListener("click", e => {
      e.preventDefault();
      trackDownload(gameId);
      window.open(url, "_blank");
    });
  }

  // ========== LOAD COMMENTS (1 read total, not a listener) ==========
  async function loadComments() {
    const commentsRef = collection(db, "games", gameId, "comments");
    const q = query(commentsRef, orderBy("timestamp", "desc"));

    const snap = await getDocs(q); // ONE-TIME FETCH = 1 READ PER COMMENT
    const list = document.getElementById("commentList");
    list.innerHTML = "";

    snap.forEach(docSnap => {
      const c = docSnap.data();
      const time = c.timestamp?.toDate ? timeAgo(c.timestamp.toDate()) : "Just now";
      const avatar = c.avatar || "https://cdn-icons-png.flaticon.com/512/149/149071.png";

      const div = document.createElement("div");
      div.classList.add("comment");
      div.innerHTML = `
        <img src="${avatar}" alt="user">
        <div>
          <p>${c.text}</p>
          <small>${c.user || "Guest"} • ${time}</small>
        </div>
      `;
      list.appendChild(div);
    });
  }

  document.getElementById("submitComment").addEventListener("click", async () => {
    const text = document.getElementById("commentInput").value.trim();
    if (!text) return;
    await addDoc(collection(db, "games", gameId, "comments"), {
      user: "Guest",
      avatar: "",
      text,
      timestamp: serverTimestamp()
    });
    document.getElementById("commentInput").value = "";
    loadComments(); // refresh manually
  });

  // ========== VIEW / DOWNLOAD TRACKING (NO READS NEEDED) ==========
  async function trackView(id) {
    const key = `kp_view_${id}`;
    const last = localStorage.getItem(key);

    if (last && Date.now() - last < 24*60*60*1000) return;

    await updateDoc(doc(db, "games", id), { views: increment(1) });
    localStorage.setItem(key, Date.now());
  }

  async function trackDownload(id) {
    await updateDoc(doc(db, "games", id), { downloads: increment(1) });
  }

  // Start
  loadGame();
  loadComments();
</script>
</body>
</html>
