<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kushwant Plays ‚Äî Game Analytics</title>
  <link rel="icon" href="assets/playslogo.png" type="image/png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: radial-gradient(circle at top, #0d0d0d 0%, #111 100%);
      color: #fff;
      padding: 40px 70px;
      overflow-x: hidden;
    }

    h1 {
      color: #ff4747;
      text-align: center;
      font-size: 2.8rem;
      margin-bottom: 60px;
      text-shadow: 0 0 12px rgba(255, 71, 71, 0.6);
    }

    a {
      color: #ff4747;
      text-decoration: none;
      font-weight: 600;
      display: inline-block;
      margin-bottom: 25px;
    }
    a:hover { text-decoration: underline; }

    /* ---------- Stats Cards ---------- */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 35px;
      margin-bottom: 70px;
      justify-items: center;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 35px 25px;
      width: 100%;
      max-width: 300px;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.6);
    }

    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 0 30px rgba(255, 71, 71, 0.3);
    }

    .card h2 { color: #ff4747; font-size: 1.2rem; margin-bottom: 10px; }
    .card p { font-size: 2.4rem; font-weight: 700; margin: 0; color: #fff; }

    /* ---------- Charts ---------- */
    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
      gap: 50px;
      margin-bottom: 60px;
    }

    .chart-box {
      background: rgba(255, 255, 255, 0.04);
      border-radius: 18px;
      padding: 40px 30px;
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.4);
    }

    .chart-box h3 {
      text-align: center;
      color: #ff4747;
      margin-bottom: 25px;
      font-size: 1.3rem;
      font-weight: 600;
    }

    canvas { width: 100% !important; height: 320px !important; }

    /* ---------- Leaderboard ---------- */
    .leaderboard {
      background: rgba(255, 255, 255, 0.04);
      border-radius: 18px;
      padding: 40px;
      box-shadow: 0 0 25px rgba(255, 71, 71, 0.2);
      max-width: 1000px;
      margin: 60px auto;
    }

    .leaderboard h2 {
      color: #ff4747;
      text-align: center;
      margin-bottom: 25px;
      font-size: 1.6rem;
      text-transform: uppercase;
    }

    /* Search + Filter Controls */
    .controls {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 25px;
    }

    .controls input, .controls select {
      padding: 10px 15px;
      border-radius: 8px;
      border: none;
      outline: none;
      font-size: 14px;
      background: rgba(255,255,255,0.1);
      color: white;
      flex: 1;
      min-width: 150px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      text-align: left;
      color: #ddd;
      font-size: 15px;
    }

    th, td { padding: 14px 12px; }
    th {
      color: #ff4747;
      cursor: pointer;
      font-weight: 600;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      user-select: none;
    }

    tr:hover { background: rgba(255, 255, 255, 0.05); transition: 0.3s; }

    td img {
      width: 60px; height: 40px;
      object-fit: cover;
      border-radius: 6px;
      margin-right: 10px;
      vertical-align: middle;
    }

    td .broken { color: #ff4747; font-weight: bold; margin-left: 6px; }

    #lastUpdated {
      text-align: center;
      color: #888;
      margin-top: 25px;
      font-size: 14px;
    }

    .footer-note {
      text-align: center;
      margin-top: 60px;
      font-size: 14px;
      color: #888;
    }

    @media (max-width: 768px) {
      body { padding: 25px 20px; }
      h1 { font-size: 2rem; margin-bottom: 40px; }
      .charts { grid-template-columns: 1fr; gap: 40px; }
      table { font-size: 14px; }
      td img { width: 50px; height: 35px; }
    }
  </style>
</head>

<body>
  <a href="dashboard.html">‚Üê Back to Dashboard</a>
  <h1>üéÆ Kushwant Plays ‚Äî Analytics Dashboard</h1>

  <!-- Overview Cards -->
  <div class="stats-grid">
    <div class="card"><h2>Total Games</h2><p id="totalGames">0</p></div>
    <div class="card"><h2>PC Games</h2><p id="pcGames">0</p></div>
    <div class="card"><h2>Android Games</h2><p id="androidGames">0</p></div>
    <div class="card"><h2>Avg Priority</h2><p id="avgPriority">0</p></div>
    <div class="card"><h2>Total Views</h2><p id="totalViews">0</p></div>
    <div class="card"><h2>Total Downloads</h2><p id="totalDownloads">0</p></div>
  </div>

  <!-- Charts -->
  <div class="charts">
    <div class="chart-box">
      <h3>üìä Platform Distribution</h3>
      <canvas id="platformChart"></canvas>
    </div>
    <div class="chart-box">
      <h3>üìÖ Games Added Per Month</h3>
      <canvas id="monthChart"></canvas>
    </div>
  </div>

  <!-- Leaderboard -->
  <div class="leaderboard">
    <h2>üèÜ All Games Performance</h2>

    <div class="controls">
      <input type="text" id="searchInput" placeholder="Search game title...">
      <select id="platformFilter">
        <option value="all">All Platforms</option>
        <option value="pc">PC</option>
        <option value="android">Android</option>
      </select>
    </div>

    <table id="leaderboardTable">
      <thead>
        <tr>
          <th>#</th>
          <th class="sortable" data-sort="title">Game</th>
          <th class="sortable" data-sort="views">Views üëÅÔ∏è</th>
          <th class="sortable" data-sort="downloads">Downloads ‚¨áÔ∏è</th>
          <th>Type</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <p id="lastUpdated">Last updated: just now</p>
  <p class="footer-note">üìà Live Data from Firebase Firestore ¬∑ ¬© Kushwant Plays</p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD_63X6oKFv0TrJpKFLVBta9azbKcZs4Q0",
      authDomain: "kushwant-plays.firebaseapp.com",
      projectId: "kushwant-plays",
      storageBucket: "kushwant-plays.firebasestorage.app",
      messagingSenderId: "257275265481",
      appId: "1:257275265481:web:eebe942139dedde428a818"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let games = [];
    let sortKey = "views";
    let sortOrder = "desc";
    let platformChart, monthChart;

    const searchInput = document.getElementById("searchInput");
    const platformFilter = document.getElementById("platformFilter");

    function secureUrl(url) {
      if (!url) return "";
      return url.startsWith("http://") ? url.replace("http://", "https://") : url;
    }

    function isBrokenLink(url) {
      if (!url || url.startsWith("magnet:") || url === "#") return true;
      return false;
    }

    function listenForUpdates() {
      const gamesRef = collection(db, "games");

      onSnapshot(gamesRef, (snapshot) => {
        console.log("üî• Data updated:", snapshot.docs.length);
        games = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        updateOverview();
        renderLeaderboard();
        renderCharts();
        updateTimestamp();
      });
    }

    function updateOverview() {
      const total = games.length;
      const pcCount = games.filter(g => g.type === "pc").length;
      const androidCount = games.filter(g => g.type === "android").length;
      const avgPriority = total ? (games.reduce((a,b)=>a+(b.priority||0),0)/total).toFixed(1):0;
      const totalViews = games.reduce((a,b)=>a+(b.views||0),0);
      const totalDownloads = games.reduce((a,b)=>a+(b.downloads||0),0);

      document.getElementById("totalGames").textContent = total;
      document.getElementById("pcGames").textContent = pcCount;
      document.getElementById("androidGames").textContent = androidCount;
      document.getElementById("avgPriority").textContent = avgPriority;
      document.getElementById("totalViews").textContent = totalViews;
      document.getElementById("totalDownloads").textContent = totalDownloads;
    }

    function renderLeaderboard() {
      const tbody = document.querySelector("#leaderboardTable tbody");
      tbody.innerHTML = "";

      const q = searchInput.value.toLowerCase();
      const filter = platformFilter.value;

      let filtered = games.filter(g =>
        g.title?.toLowerCase().includes(q) &&
        (filter === "all" || g.type === filter)
      );

      const sorted = [...filtered].sort((a,b)=>{
        let valA = a[sortKey] || 0, valB = b[sortKey] || 0;
        if (sortKey === "title") {
          return sortOrder === "asc" ? a.title.localeCompare(b.title) : b.title.localeCompare(a.title);
        } else {
          return sortOrder === "asc" ? valA - valB : valB - valA;
        }
      });

      sorted.forEach((g, i) => {
        const row = document.createElement("tr");
        const imgUrl = secureUrl(g.img);
        const broken = isBrokenLink(g.download);

        row.innerHTML = `
          <td>${i + 1}</td>
          <td>
            <img src="${imgUrl}" alt="game"
                 onerror="this.onerror=null;this.src='assets/playslogo.png';" />
            <span>${g.title}</span>
            ${broken ? '<span class="broken">‚ö†Ô∏è</span>' : ''}
          </td>
          <td>${g.views || 0}</td>
          <td>${g.downloads || 0}</td>
          <td>${g.type?.toUpperCase() || '-'}</td>
        `;
        tbody.appendChild(row);
      });
    }

    searchInput.addEventListener("input", renderLeaderboard);
    platformFilter.addEventListener("change", renderLeaderboard);

    document.querySelectorAll(".sortable").forEach(header=>{
      header.addEventListener("click", ()=>{
        const key = header.dataset.sort;
        if (sortKey === key) {
          sortOrder = sortOrder === "asc" ? "desc" : "asc";
        } else {
          sortKey = key;
          sortOrder = "desc";
        }
        renderLeaderboard();
      });
    });

    function updateTimestamp() {
      const now = new Date();
      document.getElementById("lastUpdated").textContent =
        "Last updated: " + now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function renderCharts() {
      const pcCount = games.filter(g=>g.type==="pc").length;
      const androidCount = games.filter(g=>g.type==="android").length;
      const months = {};

      games.forEach(g=>{
        if(g.createdAt?.toDate){
          const d = g.createdAt.toDate();
          const key = d.toLocaleString('default',{month:'short',year:'numeric'});
          months[key]=(months[key]||0)+1;
        }
      });

      const platformCtx=document.getElementById("platformChart");
      const monthCtx=document.getElementById("monthChart");
      if(platformChart) platformChart.destroy();
      if(monthChart) monthChart.destroy();

      platformChart=new Chart(platformCtx,{
        type:"doughnut",
        data:{
          labels:["PC","Android"],
          datasets:[{data:[pcCount,androidCount],backgroundColor:["#ff4747","#333"],borderWidth:0}]
        },
        options:{plugins:{legend:{labels:{color:"#fff"}}}}
      });

      const sortedMonths=Object.keys(months).sort((a,b)=>new Date(a)-new Date(b));
      monthChart=new Chart(monthCtx,{
        type:"bar",
        data:{
          labels:sortedMonths,
          datasets:[{label:"Games Added",data:sortedMonths.map(m=>months[m]),backgroundColor:"#ff4747",borderRadius:8}]
        },
        options:{
          scales:{
            x:{ticks:{color:"#fff"},grid:{color:"#222"}},
            y:{ticks:{color:"#fff"},grid:{color:"#222"}}
          },
          plugins:{legend:{display:false}}
        }
      });
    }

    listenForUpdates();
  </script>
</body>
</html>
