<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manage Games ‚Äî Kushwant Plays</title>
  <link rel="icon" href="assets/playslogo.png">
  <style>
    body {
      margin: 0;
      font-family: Poppins, sans-serif;
      background: #0b0b0b;
      color: #fff;
      padding: 40px;
    }
    a { color: #ff4747; text-decoration: none; }
    h1 { color: #ff4747; margin-bottom: 20px; }

    #searchBar {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: none;
      outline: none;
      font-size: 15px;
      background: #111;
      color: #fff;
      margin-bottom: 20px;
    }

    /* ‚úÖ Grid layout for cards */
    #gamesList {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }
    .game-card {
      background: #111;
      border: 1px solid #222;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 0 15px rgba(0,0,0,0.4);
      cursor: grab;
      transition: transform 0.2s ease;
    }
    .game-card:hover { transform: translateY(-4px); }
    .dragging { opacity: 0.5; }

    .game-card img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .game-card h3 { margin: 5px 0; font-size: 18px; color: #fff; }
    .game-card p { color: #bbb; font-size: 14px; margin: 5px 0; }

    .actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .btn {
      flex: 1;
      border: none;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.3s;
    }
    .btn.download { background: #222; color: #fff; }
    .btn.download:hover { background: #333; }
    .btn.delete { background: #ff4747; color: #fff; }
    .btn.delete:hover { background: #ff1a1a; }
    .btn.edit { background: #333; color: #fff; }
    .btn.edit:hover { background: #555; }

    #status { margin-top: 20px; color: #bbb; text-align:center; }

    .saveOrderBtn {
      margin-top: 20px;
      background: #ff4747;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display:block;
      margin-inline:auto;
    }
    .saveOrderBtn:hover { opacity: 0.85; }

    /* ‚ú® Modal Styling */
    #editModal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal-content {
      background: rgba(20,20,20,0.95);
      border: 1px solid #222;
      border-radius: 12px;
      width: 90%;
      max-width: 420px;
      padding: 25px;
      box-shadow: 0 0 25px rgba(255,71,71,0.3);
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    .modal-content h2 {
      margin-top: 0;
      color: #ff4747;
      text-align: center;
      margin-bottom: 15px;
    }
    .modal-content label {
      display: block;
      margin-top: 10px;
      font-size: 14px;
      color: #bbb;
    }
    .modal-content input, .modal-content textarea {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: #111;
      color: #fff;
      margin-top: 6px;
    }
    .modal-img {
      margin-top: 10px;
      text-align: center;
    }
    .modal-img img {
      width: 100%;
      max-width: 200px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(255,71,71,0.4);
      margin-bottom: 10px;
    }
    .modal-buttons {
      text-align: right;
      margin-top: 15px;
    }
    .save-btn, .cancel-btn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin-left: 8px;
    }
    .save-btn { background: #ff4747; color: #fff; }
    .cancel-btn { background: #333; color: #fff; }
    .save-btn:hover { background: #ff1a1a; }
    .cancel-btn:hover { background: #444; }

    @media (max-width: 768px) {
      #gamesList {
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      }
    }
  </style>
</head>
<body>
  <a href="dashboard.html">‚Üê Back to Dashboard</a>
  <h1>Manage Games</h1>

  <input type="text" id="searchBar" placeholder="Search by title or platform...">
  <div id="gamesList">Loading games...</div>
  <button id="saveOrderBtn" class="saveOrderBtn" style="display:none;">Save Order</button>
  <p id="status"></p>

  <!-- ü™Ñ Edit Modal -->
  <div id="editModal">
    <div class="modal-content">
      <h2>Edit Game</h2>
      <label>Title</label>
      <input type="text" id="editTitle">
      <label>Description</label>
      <textarea id="editDesc"></textarea>
      <label>Download Link</label>
      <input type="url" id="editDownload">
      <label>Image URL (or upload below)</label>
      <input type="url" id="editImg">
      <input type="file" id="editFile" accept="image/*">
      <div class="modal-img">
        <img id="editPreview" src="" alt="Preview">
      </div>
      <div class="modal-buttons">
        <button class="cancel-btn">Cancel</button>
        <button class="save-btn">Save</button>
      </div>
    </div>
  </div>

  <script type="module">
  import "./scripts/auth-guard.js";
  import {
    getFirestore, collection, getDocs, deleteDoc, doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  const db = getFirestore();

  const CLOUD_NAME = "dq3vvca7m";
  const UPLOAD_PRESET = "public_upload";

  const list = document.getElementById("gamesList");
  const statusEl = document.getElementById("status");
  const searchBar = document.getElementById("searchBar");
  const saveOrderBtn = document.getElementById("saveOrderBtn");

  const modal = document.getElementById("editModal");
  const editTitle = document.getElementById("editTitle");
  const editDesc = document.getElementById("editDesc");
  const editDownload = document.getElementById("editDownload");
  const editImg = document.getElementById("editImg");
  const editFile = document.getElementById("editFile");
  const editPreview = document.getElementById("editPreview");
  const saveBtn = document.querySelector(".save-btn");
  const cancelBtn = document.querySelector(".cancel-btn");

  let gamesData = [];
  let currentEditId = null;
  let selectedFile = null;
  let isReordered = false;

  const CACHE_KEY = "manage_games_cache";
  const CACHE_TIME_KEY = "manage_games_time";

  async function loadGames() {
    statusEl.textContent = "Fetching games...";

    // ---- Load from cache first (0 reads) ----
    const cached = localStorage.getItem(CACHE_KEY);
    const lastFetch = localStorage.getItem(CACHE_TIME_KEY);
    const now = Date.now();

    if (cached && lastFetch && now - lastFetch < 24 * 60 * 60 * 1000) {
      gamesData = JSON.parse(cached);
      gamesData.sort((a,b)=> (b.priority||0)-(a.priority||0));
      renderGames(gamesData);
      statusEl.textContent = "Loaded from cache ‚úî";
      return;
    }

    // ---- Firestore fetch (1 read per game) ----
    const snap = await getDocs(collection(db, "games"));
    gamesData = snap.docs.map(d => ({ id: d.id, priority: d.data().priority ?? 0, ...d.data() }));
    gamesData.sort((a,b)=> (b.priority||0)-(a.priority||0));

    // ---- Save to cache ----
    localStorage.setItem(CACHE_KEY, JSON.stringify(gamesData));
    localStorage.setItem(CACHE_TIME_KEY, now);

    renderGames(gamesData);
    statusEl.textContent = "Games loaded ‚úî";
  }

  function saveCache() {
    localStorage.setItem(CACHE_KEY, JSON.stringify(gamesData));
    localStorage.setItem(CACHE_TIME_KEY, Date.now());
  }

  function renderGames(data) {
    list.innerHTML = data.length
      ? data.map((g,i)=>`
        <div class="game-card" draggable="true" data-id="${g.id}">
          <h3>${i+1}. ${g.title}</h3>
          <img src="${g.img}">
          <p>${g.desc}</p>
          <p>Platform: <strong>${g.type?.toUpperCase()||"?"}</strong></p>
          <p>Priority: <strong>${g.priority||"None"}</strong></p>
          <div class="actions">
            <button class="btn download" onclick="window.open('${g.download}','_blank')">Download</button>
            <button class="btn edit" data-id="${g.id}">Edit</button>
            <button class="btn delete" data-id="${g.id}">Delete</button>
          </div>
        </div>
      `).join('')
      : "<p>No games found.</p>";

    enableDragAndDrop();
    attachHandlers();
    saveOrderBtn.style.display = "block";
  }

  // ---- Search ----
  searchBar.addEventListener("input", e=>{
    const q = e.target.value.toLowerCase();
    renderGames(gamesData.filter(g =>
      g.title.toLowerCase().includes(q) ||
      g.type.toLowerCase().includes(q)
    ));
  });

  // ---- Drag and Drop ----
  function enableDragAndDrop() {
    const cards = document.querySelectorAll(".game-card");
    let dragged = null;

    cards.forEach(card=>{
      card.addEventListener("dragstart",()=>{
        dragged = card;
        card.classList.add("dragging");
      });

      card.addEventListener("dragover",e=>{
        e.preventDefault();
        const after = getDragAfterElement(list,e.clientY);
        if (!after) list.appendChild(dragged);
        else list.insertBefore(dragged, after);
      });

      card.addEventListener("dragend",()=>{
        dragged.classList.remove("dragging");
        isReordered = true;
      });
    });
  }

  function getDragAfterElement(container,y){
    const els=[...container.querySelectorAll('.game-card:not(.dragging)')];
    return els.reduce((c,child)=>{
      const box=child.getBoundingClientRect();
      const off=y-box.top-box.height/2;
      if(off<0 && off>c.offset) return {offset:off,element:child};
      return c;
    },{offset:-Infinity}).element;
  }

  // ---- Save order ----
  saveOrderBtn.addEventListener("click",async()=>{
    if(!isReordered) return alert("No changes to save.");

    const cards = [...document.querySelectorAll(".game-card")];

    statusEl.textContent="Saving new order...";

    for (let i=0; i<cards.length; i++) {
      const id = cards[i].dataset.id;
      await updateDoc(doc(db,"games",id), { priority: cards.length - i });

      // update local copy too
      const item = gamesData.find(x=>x.id===id);
      if (item) item.priority = cards.length - i;
    }

    saveCache();

    statusEl.textContent="Priority updated ‚úî";
    isReordered = false;

    renderGames(gamesData);
  });

  // ---- Edit/Delete ----
  function attachHandlers(){
    document.querySelectorAll(".btn.delete").forEach(b=>{
      b.addEventListener("click",async()=>{
        if(!confirm("Delete this game?")) return;

        await deleteDoc(doc(db,"games",b.dataset.id));

        gamesData = gamesData.filter(g=>g.id !== b.dataset.id);
        saveCache();

        statusEl.textContent="Deleted ‚úî";
        renderGames(gamesData);
      });
    });

    document.querySelectorAll(".btn.edit").forEach(b=>{
      b.addEventListener("click",()=>openEditModal(b.dataset.id));
    });
  }

  function openEditModal(id){
    const g = gamesData.find(x=>x.id===id);
    if(!g) return;

    currentEditId = id;
    editTitle.value = g.title;
    editDesc.value = g.desc;
    editDownload.value = g.download;
    editImg.value = g.img;
    editPreview.src = g.img;

    selectedFile = null;
    modal.style.display = "flex";
  }

  editImg.addEventListener("input",()=>editPreview.src = editImg.value.trim());
  editFile.addEventListener("change",()=>{
    selectedFile = editFile.files[0];
    if(selectedFile) editPreview.src = URL.createObjectURL(selectedFile);
  });

  async function uploadToCloudinary(file){
    const fd = new FormData();
    fd.append("file", file);
    fd.append("upload_preset", UPLOAD_PRESET);
    fd.append("folder", "games");

    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{
      method:"POST",
      body:fd
    });

    const data = await res.json();
    if(!res.ok) throw new Error("Upload failed");
    return data.secure_url;
  }

  saveBtn.addEventListener("click", async ()=>{
    if (!currentEditId) return;

    try {
      let finalImg = editImg.value.trim();

      if (selectedFile) {
        statusEl.textContent = "Uploading image...";
        finalImg = await uploadToCloudinary(selectedFile);
      }

      await updateDoc(doc(db, "games", currentEditId), {
        title: editTitle.value.trim(),
        desc: editDesc.value.trim(),
        download: editDownload.value.trim(),
        img: finalImg
      });

      // update locally
      const g = gamesData.find(x=>x.id===currentEditId);
      if (g) {
        g.title = editTitle.value.trim();
        g.desc = editDesc.value.trim();
        g.download = editDownload.value.trim();
        g.img = finalImg;
      }

      saveCache();

      modal.style.display = "none";
      statusEl.textContent = "Updated ‚úî";
      renderGames(gamesData);

    } catch (err) {
      alert("Error: " + err.message);
    }
  });

  cancelBtn.addEventListener("click",()=>modal.style.display="none");
  window.addEventListener("click",e=>{if(e.target===modal) modal.style.display="none";});

  loadGames();
</script>
</body>
</html>
