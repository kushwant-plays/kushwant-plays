<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Add Game — Kushwant Plays</title>
  <link rel="icon" href="assets/playslogo.png">
  <style>
    body {
      margin: 0;
      font-family: Poppins, sans-serif;
      background: #0b0b0b;
      color: #fff;
      padding: 40px;
    }
    h1 { color: #ff4747; }
    label {
      display: block;
      margin-top: 16px;
      margin-bottom: 6px;
      font-weight: 500;
    }
    input, textarea, select {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      background: #111;
      color: #fff;
      outline: none;
      font-size: 15px;
    }
    textarea { min-height: 90px; resize: vertical; }
    button {
      margin-top: 20px;
      padding: 12px 18px;
      border: none;
      border-radius: 8px;
      background: #ff4747;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover { opacity: 0.85; }
    #preview {
      margin-top: 10px;
      max-width: 220px;
      border-radius: 8px;
      display: none;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
    }
    #status { margin-top: 16px; color: #bbb; }
    a { color: #ff4747; text-decoration: none; }
  </style>
</head>
<body>
  <a href="dashboard.html">← Back to Dashboard</a>
  <h1>Add New Game</h1>

  <form id="addGameForm">
    <label for="title">Game Title</label>
    <input type="text" id="title" required placeholder="e.g. GTA V">

    <label for="desc">Description</label>
    <textarea id="desc" required placeholder="Short description"></textarea>

    <label for="type">Platform</label>
    <select id="type">
      <option value="pc">PC</option>
      <option value="android">Android</option>
    </select>

    <label for="download">Download Link</label>
    <input type="url" id="download" required placeholder="https://example.com/game.zip">

    <label for="imageFile">Game Cover (choose file OR paste URL below)</label>
    <input type="file" id="imageFile" accept="image/*">
    
    <label for="imageUrl">OR Image URL</label>
    <input type="url" id="imageUrl" placeholder="https://example.com/game-cover.jpg">

    <img id="preview" alt="Preview">

    <button type="submit">Upload & Save Game</button>
  </form>

  <p id="status"></p>

  <script type="module">
  import "./scripts/auth-guard.js";
  import {
    getFirestore,
    collection,
    addDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  const CLOUD_NAME = "dq3vvca7m";
  const UPLOAD_PRESET = "public_upload";
  const db = getFirestore();

  const form = document.getElementById("addGameForm");
  const statusEl = document.getElementById("status");
  const imgInput = document.getElementById("imageFile");
  const imgUrlInput = document.getElementById("imageUrl");
  const preview = document.getElementById("preview");

  let selectedFile = null;

  // Image file preview
  imgInput.addEventListener("change", (e) => {
    selectedFile = e.target.files[0];
    if (selectedFile) {
      preview.src = URL.createObjectURL(selectedFile);
      preview.style.display = "block";
      imgUrlInput.value = "";
    }
  });

  // Image URL preview
  imgUrlInput.addEventListener("input", () => {
    const url = imgUrlInput.value.trim();
    if (url) {
      preview.src = url;
      preview.style.display = "block";
      selectedFile = null;
      imgInput.value = "";
    }
  });

  // Submit
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const title = form.title.value.trim();
    const desc = form.desc.value.trim();
    const type = form.type.value.trim().toLowerCase(); // pc/android
    const download = form.download.value.trim();
    const imageUrl = imgUrlInput.value.trim();

    if (!title || !desc || !type || !download || (!selectedFile && !imageUrl)) {
      alert("All fields are required, including an image.");
      return;
    }

    try {
      statusEl.textContent = selectedFile
        ? "Uploading image..."
        : "Using image URL...";

      let finalImageUrl = imageUrl;

      if (selectedFile) {
        finalImageUrl = await uploadToCloudinary(selectedFile);
      }

      statusEl.textContent = "Saving in Firestore...";

      await addDoc(collection(db, "games"), {
        title,
        desc,
        type,
        download,
        img: finalImageUrl,
        priority: 0,
        views: 0,
        downloads: 0,
        createdAt: serverTimestamp(),
      });

      statusEl.textContent = "✅ Game added!";
      form.reset();
      preview.style.display = "none";
      selectedFile = null;

    } catch (err) {
      console.error(err);
      statusEl.textContent = "❌ Error: " + err.message;
    }
  });

  async function uploadToCloudinary(file) {
    const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
    const data = new FormData();
    data.append("file", file);
    data.append("upload_preset", UPLOAD_PRESET);
    data.append("folder", "games");

    const res = await fetch(url, { method: "POST", body: data });
    if (!res.ok) throw new Error("Image upload failed");
    const json = await res.json();
    return json.secure_url;
  }
</script>
</body>
</html>
